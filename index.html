<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tank Monitoring Dashboard - FIMA Bulking Services</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://img.icons8.com/color/48/000000/temperature.png">
    <style>
        /* ===== MINIMALIST SIDEBAR - FIXED SPACING ===== */
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* Mobile Overlay for Sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            backdrop-filter: blur(2px);
        }

        .sidebar-minimalist {
            background: #ffffff;
            color: #1f2937;
            width: 330px; 
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            padding: 25px 30px; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.03);
            z-index: 1000;
            border-right: 1px solid #e5e7eb;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-minimalist:hover {
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            flex-shrink: 0;
        }

        .sidebar-title {
        font-size: 20px; /* Kurangkan sikit dari 20px supaya muat */
        font-weight: 700;
        color: #111827;
        letter-spacing: -0.5px;
        white-space: nowrap; /* <--- INI PENTING: Paksa teks jadi satu baris */
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            margin-top: 2px;
        }

        /* Navigation Items */
        .nav-group {
            margin-bottom: 30px;
        }

        .nav-group-title {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .nav-item {
            margin-bottom: 6px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            color: #4b5563;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.2s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: transparent;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background: #f9fafb;
            color: #4f46e5;
            transform: translateX(4px);
        }

        .nav-link:hover::before {
            background: #4f46e5;
        }

        .nav-link.active {
            background: rgba(79, 70, 229, 0.08);
            color: #4f46e5;
        }

        .nav-link.active::before {
            background: #4f46e5;
        }

        .nav-link i {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* ===== STATUS LEGEND IN SIDEBAR ===== */
        .sidebar-legend {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
        }

        .sidebar-legend h4 {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #4b5563;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-normal { background: #10b981; }
        .legend-warning { background: #f59e0b; }
        .legend-danger { background: #ef4444; }

        /* System Summary Card */
        .system-summary-card {
            background: #f9fafb;
            border-radius: 14px;
            padding: 24px;
            margin-top: 0;
            border: 1px solid #e5e7eb;
            backdrop-filter: blur(10px);
        }

        .summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 15px;
            color: #111827;
            font-weight: 600;
        }

        .summary-badge {
            background: #10b981;
            color: white;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }

        .summary-badge.warning { background: #f59e0b; }
        .summary-badge.danger { background: #ef4444; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr); /* 1 Column for vertical stacking */
            gap: 10px;
        }

        /* MODIFIED: Side-by-side layout for Summary Item */
        .summary-item {
            display: flex;
            flex-direction: row; /* Horizontal layout */
            align-items: center; /* Vertical center */
            justify-content: space-between; /* Space between text and number */
            gap: 12px;
            margin-bottom: 8px;
        }

        .summary-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            flex: 1; /* Allow text to take space */
            line-height: 1.3;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            line-height: 1.2;
        }

        .summary-value.small { font-size: 20px; }

        /* Main Content Area */
        .main-content {
            margin-left: 300px;
            padding: 0;
            min-height: 100vh;
            background: #f9fafb;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Top Navigation */
        .top-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 35px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-toggle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4f46e5;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 20px;
        }

        .nav-toggle:hover {
            background: #4f46e5;
            color: white;
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #4f46e5;
            color: white !important;
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .nav-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        .nav-btn:hover i, .nav-btn:hover span {
            color: white !important;
        }

        /* Dashboard Content */
        .dashboard-content {
            padding: 30px 35px;
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .alert-close {
            margin-left: auto;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .alert-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Location Info */
        .location-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
        }

        .location-icon {
            width: 44px;
            height: 44px;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4f46e5;
            font-size: 22px;
            flex-shrink: 0;
        }

        .site-badge {
            margin-left: auto;
            background: #f9fafb;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            border: 1px solid #e5e7eb;
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #e5e7eb, transparent);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .stat-card:hover::before {
            background: linear-gradient(90deg, #4f46e5, #818cf8);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #111827;
            line-height: 1;
            letter-spacing: -0.5px;
        }

        .stat-unit {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: #f9fafb;
            color: #4f46e5;
        }

        .stat-content h4 {
            font-size: 15px;
            color: #4b5563;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin-top: 0;
        }

        .stat-content p {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 12px;
            margin-top: 0;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .stat-trend i { font-size: 16px; }

        /* Status Cards */
        .status-normal { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .status-warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .status-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        .status-normal .stat-icon { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .status-warning .stat-icon { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .status-danger .stat-icon { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        /* ===== TANK LOCATIONS MAP SECTION ===== */
        .map-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .map-section-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .map-section-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .map-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .map-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
            font-weight: 500;
        }

        .map-btn:hover {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .map-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
            padding: 24px;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            z-index: 1; /* Keep below modal */
        }

        /* Temperature Statistics Card (BESIDE MAP) */
        .map-stats-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .map-stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .map-stats-header h4 {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .map-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .map-stat-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }

        .map-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .map-stat-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .map-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            line-height: 1.2;
        }

        .map-stat-unit {
            font-size: 14px;
            color: #6b7280;
            margin-left: 4px;
        }

        .map-stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9fafb;
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .tank-detail-content { padding: 0; }

        .detail-header {
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
        }

        .tank-identifier h2 {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .tank-status-badge-large {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .tank-temp-large {
            text-align: center;
            margin: 20px 0;
        }

        .tank-temp-large span {
            font-size: 48px;
            font-weight: 800;
            color: #111827;
            line-height: 1;
        }

        .tank-temp-large .unit {
            font-size: 24px;
            color: #6b7280;
            margin-left: 4px;
        }

        .temp-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            color: #6b7280;
            font-size: 14px;
        }

        .temp-indicator i { font-size: 20px; }
        .temp-indicator.up { color: #ef4444; }
        .temp-indicator.down { color: #10b981; }
        .temp-indicator.stable { color: #6b7280; }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 24px;
        }

        .detail-grid-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .detail-grid-item i {
            font-size: 20px;
            color: #4f46e5;
            margin-bottom: 4px;
        }

        .detail-grid-item label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .detail-grid-item span {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        /* Date Range Section */
        .date-range-section {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .date-range-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-selector-simple {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .date-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            min-width: 120px;
        }

        .date-input-group {
            flex: 1;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #111827;
            background: white;
            min-width: 130px;
        }

        .date-btn {
            padding: 10px 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            color: #6b7280;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .date-btn:hover, .date-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .quick-select-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .quick-select-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            color: #6b7280;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-select-btn:hover { background: #f9fafb; }
        .quick-select-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; }

        .selected-date-display {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #0369a1;
        }

        .selected-date-display i { font-size: 18px; color: #0ea5e9; }
        .selected-date-text strong { color: #111827; }

        /* Chart Controls */
        .chart-controls {
            padding: 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-control-select {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #111827;
            font-size: 13px;
            min-width: 120px;
        }

        .data-info {
            padding: 16px 24px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin: 0 auto;
            padding: 24px;
        }

        .chart-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #94a3b8;
            text-align: center;
        }

        .chart-loading i { font-size: 40px; margin-bottom: 16px; }

        /* Temperature Values */
        .temperature-values {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        .temperature-value-item { text-align: center; }
        .temperature-value-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .temperature-value {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        .modal-actions {
            padding: 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            background: #f9fafb;
            border-radius: 0 0 16px 16px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-btn.primary { background: #4f46e5; color: white; }
        .modal-btn.primary:hover { background: #4338ca; }
        .modal-btn.secondary { background: white; color: #4b5563; border: 1px solid #e5e7eb; }
        .modal-btn.secondary:hover { background: #f9fafb; border-color: #d1d5db; }

        /* Position Editor Styles */
        .position-editor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 99999;
            justify-content: center;
            align-items: center;
        }

        .position-editor-content {
            background: white;
            width: 90%;
            max-width: 800px;
            height: 80%;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .position-editor-header {
            padding: 20px 24px;
            background: #4f46e5;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-editor-header h3 { margin: 0; font-size: 18px; font-weight: 600; }

        .position-editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .position-editor-map { flex: 1; height: 100%; }

        .position-editor-sidebar {
            width: 300px;
            background: #f9fafb;
            border-left: 1px solid #e5e7eb;
            padding: 20px;
            overflow-y: auto;
        }

        .position-controls {
            margin-bottom: 20px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .tank-position-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tank-position-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .tank-position-item.active {
            background: rgba(79, 70, 229, 0.1);
            border-color: #4f46e5;
        }

        .position-instructions {
            margin-top: 20px;
            padding: 16px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            font-size: 13px;
            color: #0369a1;
        }

        .leaflet-marker-draggable { cursor: move !important; }
        
        .position-save-confirmation {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 100000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* ===== DARK THEME STYLES ===== */
        body.dark-theme { background: #0f172a; color: #e2e8f0; }
        body.dark-theme .sidebar-minimalist { background: #1e293b; color: #e2e8f0; border-right-color: #334155; }
        body.dark-theme .sidebar-header { border-bottom-color: #334155; }
        body.dark-theme .sidebar-title { color: #f1f5f9; }
        body.dark-theme .sidebar-subtitle { color: #94a3b8; }
        body.dark-theme .nav-group-title { color: #94a3b8; }
        body.dark-theme .nav-link { color: #cbd5e1; }
        body.dark-theme .nav-link:hover { background: #334155; color: #818cf8; }
        body.dark-theme .nav-link.active { background: rgba(79, 70, 229, 0.2); color: #818cf8; }
        body.dark-theme .sidebar-legend { background: #1e293b; border-color: #334155; color: #e2e8f0; }
        body.dark-theme .sidebar-legend h4 { color: #f1f5f9; }
        body.dark-theme .legend-item { color: #cbd5e1; }
        body.dark-theme .system-summary-card { background: #1e293b; border-color: #334155; }
        body.dark-theme .summary-title { color: #f1f5f9; }
        body.dark-theme .summary-label { color: #94a3b8; }
        body.dark-theme .summary-value { color: #f1f5f9; }
        body.dark-theme .main-content { background: #0f172a; }
        body.dark-theme .top-nav { background: rgba(30, 41, 59, 0.95); border-bottom-color: #334155; }
        body.dark-theme .nav-toggle { background: #1e293b; border-color: #334155; color: #818cf8; }
        body.dark-theme .nav-toggle:hover { background: #4f46e5; color: #f1f5f9; }
        body.dark-theme .page-title { color: #f1f5f9; }
        body.dark-theme .nav-btn { background: #1e293b; border-color: #334155; color: #cbd5e1; }
        body.dark-theme .nav-btn:hover { background: #4f46e5; color: #f1f5f9 !important; border-color: #4f46e5; }
        body.dark-theme .nav-btn.active { background: #4f46e5; color: #f1f5f9; border-color: #4f46e5; }
        body.dark-theme .location-card { background: #1e293b; border-color: #334155; color: #e2e8f0; }
        body.dark-theme .location-icon { background: rgba(79, 70, 229, 0.2); color: #818cf8; }
        body.dark-theme .site-badge { background: #334155; color: #94a3b8; border-color: #475569; }
        body.dark-theme .stat-card { background: #1e293b; border-color: #334155; color: #e2e8f0; }
        body.dark-theme .stat-value { color: #f1f5f9; }
        body.dark-theme .stat-unit { color: #94a3b8; }
        body.dark-theme .stat-icon { background: #334155; color: #818cf8; }
        body.dark-theme .stat-content h4 { color: #cbd5e1; }
        body.dark-theme .stat-content p { color: #94a3b8; }
        body.dark-theme .stat-trend { color: #94a3b8; }
        body.dark-theme .status-normal { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        body.dark-theme .status-warning { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        body.dark-theme .status-danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        body.dark-theme .status-normal .stat-icon { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        body.dark-theme .status-warning .stat-icon { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        body.dark-theme .status-danger .stat-icon { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        body.dark-theme .map-section { background: #1e293b; border-color: #334155; }
        body.dark-theme .map-section-header { background: #1e293b; border-bottom-color: #334155; }
        body.dark-theme .map-section-header h3 { color: #f1f5f9; }
        body.dark-theme .map-btn { background: #1e293b; border-color: #334155; color: #94a3b8; }
        body.dark-theme .map-btn:hover { background: #4f46e5; color: #f1f5f9; border-color: #4f46e5; }
        body.dark-theme .map-stats-card { background: #1e293b; border-color: #334155; }
        body.dark-theme .map-stats-header h4 { color: #f1f5f9; }
        body.dark-theme .map-stat-item { background: #0f172a; border-color: #334155; }
        body.dark-theme .map-stat-label { color: #94a3b8; }
        body.dark-theme .map-stat-value { color: #f1f5f9; }
        body.dark-theme .map-stat-unit { color: #94a3b8; }
        body.dark-theme .map-stat-trend { color: #94a3b8; }
        body.dark-theme .modal { background: #1e293b; color: #e2e8f0; }
        body.dark-theme .modal-header { background: #1e293b; border-bottom-color: #334155; }
        body.dark-theme .modal-header h3 { color: #f1f5f9; }
        body.dark-theme .modal-close { color: #94a3b8; }
        body.dark-theme .modal-close:hover { background: #334155; color: #f1f5f9; }
        body.dark-theme .detail-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom-color: #334155; }
        body.dark-theme .tank-identifier h2 { color: #f1f5f9; }
        body.dark-theme .tank-temp-large span { color: #f1f5f9; }
        body.dark-theme .tank-temp-large .unit { color: #94a3b8; }
        body.dark-theme .detail-grid-item { background: #1e293b; border-color: #334155; }
        body.dark-theme .detail-grid-item i { color: #818cf8; }
        body.dark-theme .detail-grid-item label { color: #94a3b8; }
        body.dark-theme .detail-grid-item span { color: #f1f5f9; }
        body.dark-theme .date-range-section { background: #1e293b; border-bottom-color: #334155; }
        body.dark-theme .date-range-title { color: #f1f5f9; }
        body.dark-theme .date-label { color: #94a3b8; }
        body.dark-theme .date-input { background: #0f172a; border-color: #334155; color: #f1f5f9; }
        body.dark-theme .date-input:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        body.dark-theme .date-btn { background: #0f172a; border-color: #334155; color: #94a3b8; }
        body.dark-theme .date-btn:hover { background: #4f46e5; color: #f1f5f9; border-color: #4f46e5; }
        body.dark-theme .date-btn.active { background: #4f46e5; color: #f1f5f9; border-color: #4f46e5; }
        body.dark-theme .quick-select-btn { background: #0f172a; border-color: #334155; color: #94a3b8; }
        body.dark-theme .quick-select-btn:hover { background: #334155; border-color: #475569; }
        body.dark-theme .quick-select-btn.active { background: #4f46e5; color: #f1f5f9; border-color: #4f46e5; }
        body.dark-theme .selected-date-display { background: rgba(14, 165, 233, 0.1); border-color: #0ea5e9; color: #38bdf8; }
        body.dark-theme .selected-date-display i { color: #38bdf8; }
        body.dark-theme .selected-date-text { color: #38bdf8; }
        body.dark-theme .selected-date-text strong { color: #f1f5f9; }
        body.dark-theme .chart-controls { background: #1e293b; border-bottom-color: #334155; }
        body.dark-theme .chart-control-group label { color: #94a3b8; }
        body.dark-theme .chart-control-select { background: #0f172a; border-color: #334155; color: #f1f5f9; }
        body.dark-theme .chart-control-select:focus { border-color: #4f46e5; }
        body.dark-theme .data-info { background: #1e293b; border-bottom-color: #334155; color: #94a3b8; }
        body.dark-theme .temperature-values { background: #1e293b; border-color: #334155; }
        body.dark-theme .temperature-value-label { color: #94a3b8; }
        body.dark-theme .temperature-value { color: #f1f5f9; }
        body.dark-theme .modal-actions { background: #1e293b; border-top-color: #334155; }
        body.dark-theme .modal-btn.secondary { background: #0f172a; color: #cbd5e1; border-color: #334155; }
        body.dark-theme .modal-btn.secondary:hover { background: #334155; border-color: #475569; }
        body.dark-theme .chart-loading { color: #64748b; }
        body.dark-theme .leaflet-tile { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }
        body.dark-theme .leaflet-control { filter: invert(1) hue-rotate(180deg); }
        body.dark-theme #map { border-color: #334155; }
        body.dark-theme #connection-status { color: #94a3b8; }
        body.dark-theme .alert-banner { background: linear-gradient(135deg, #059669, #047857); color: #f0fdfa; }
        body.dark-theme .alert-close { background: rgba(255, 255, 255, 0.1); color: #f0fdfa; }
        body.dark-theme .alert-close:hover { background: rgba(255, 255, 255, 0.2); }
        body.dark-theme .position-editor-content { background: #1e293b; color: #e2e8f0; }
        body.dark-theme .position-editor-sidebar { background: #1e293b; border-left-color: #334155; }
        body.dark-theme .position-controls { background: #0f172a; border-color: #334155; }
        body.dark-theme .tank-position-item { background: #0f172a; border-color: #334155; color: #cbd5e1; }
        body.dark-theme .tank-position-item:hover { background: #1e293b; border-color: #4f46e5; }
        body.dark-theme .tank-position-item.active { background: rgba(79, 70, 229, 0.2); border-color: #4f46e5; }
        body.dark-theme .position-instructions { background: rgba(14, 165, 233, 0.1); border-color: #0ea5e9; color: #38bdf8; }

        /* ===== MOBILE RESPONSIVE STYLES ===== */
        @media (max-width: 1024px) {
            .stats-overview {
                grid-template-columns: repeat(3, 1fr);
            }
            .map-container {
                grid-template-columns: 1fr;
            }
            .map-stats-card {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            /* Sidebar hidden by default on mobile */
            .sidebar-minimalist {
                transform: translateX(-100%);
                width: 280px;
                padding: 20px;
            }
            
            /* Class added via JS to show sidebar */
            .sidebar-minimalist.active {
                transform: translateX(0);
            }

            /* Main content takes full width on mobile */
            .main-content {
                margin-left: 0;
                width: 100%;
            }

            /* Adjust nav padding */
            .top-nav {
                padding: 15px 20px;
            }

            .page-title {
                font-size: 16px;
            }

            /* Hide button text on small screens, keep icons */
            .nav-btn span {
                display: none;
            }
            
            .nav-btn {
                padding: 10px;
            }

            .dashboard-content {
                padding: 20px;
            }

            /* Stack stats cards vertically */
            .stats-overview {
                grid-template-columns: 1fr;
            }

            /* Stack Location Card info */
            .location-card {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .site-badge {
                margin-left: 0;
            }

            /* Map adjustments */
            #map {
                height: 300px;
            }

            .map-controls {
                width: 100%;
                justify-content: flex-start;
            }
            
            .map-btn {
                flex-grow: 1;
                justify-content: center;
                font-size: 13px;
                padding: 8px 10px;
            }

            /* Modal adjustments */
            .modal {
                width: 95%;
                max-height: 90vh;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .temperature-values {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .chart-control-group {
                width: 100%;
            }
            
            .chart-control-select {
                flex: 1;
            }

            /* Position Editor Mobile */
            .position-editor-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }
            
            .position-editor-body {
                flex-direction: column;
            }
            
            .position-editor-map {
                height: 60%;
            }
            
            .position-editor-sidebar {
                width: 100%;
                height: 40%;
                border-left: none;
                border-top: 1px solid #e5e7eb;
            }
        }

        /* ===== AI CHATBOT STYLES ===== */
        .chat-widget {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .chat-button {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.4);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .chat-button:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .chat-window {
            width: 380px;
            height: 550px;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            display: none; /* Toggle hidden */
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            animation: chatSlideUp 0.4s ease;
        }

        @keyframes chatSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .chat-header {
            padding: 20px;
            background: #4f46e5;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.bot {
            align-self: flex-start;
            background: white;
            color: #1f2937;
            border-bottom-left-radius: 2px;
            border: 1px solid #e5e7eb;
        }

        .message.user {
            align-self: flex-end;
            background: #4f46e5;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 15px;
            outline: none;
            font-size: 14px;
        }

        .chat-send {
            background: #4f46e5;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dark Theme Chat Fixes */
        body.dark-theme .chat-window { background: #1e293b; border-color: #334155; }
        body.dark-theme .chat-messages { background: #0f172a; }
        body.dark-theme .message.bot { background: #1e293b; color: #f1f5f9; border-color: #334155; }
        body.dark-theme .chat-input-area { background: #1e293b; border-top-color: #334155; }
        body.dark-theme .chat-input { background: #0f172a; border-color: #334155; color: white; }

        @media (max-width: 480px) {
            .chat-window {
                width: calc(100vw - 40px);
                height: 450px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="mobile-overlay"></div>

    <div class="sidebar-minimalist">
        <div class="sidebar-header">
            <div class="sidebar-icon">
                <i class='bx bxs-thermometer'></i>
            </div>
            <div>
                <div class="sidebar-title">FIMA Tank Monitoring</div>
                <div class="sidebar-subtitle">Chemical Storage Facility</div>
            </div>
        </div>
        
        <div class="nav-group">
            <div class="nav-group-title">Dashboard</div>
            <div class="nav-item">
                <a href="index.html" class="nav-link active">
                    <i class='bx bxs-dashboard'></i>
                    <span>Dashboard</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="chart.html" class="nav-link">
                    <i class='bx bxs-analyse'></i> <span>Temperature Analytics</span>
                </a>
            </div>
        </div>
        
        <div class="sidebar-legend">
            <h4><i class='bx bx-legend'></i> Status Legend</h4>
            <div class="legend-item">
                <div class="legend-color legend-normal"></div>
                <span>Normal (< 50C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-warning"></div>
                <span>Hot ( 50C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-danger"></div>
                <span>Critical ( 60C)</span>
            </div>
        </div>
        
        <div class="system-summary-card">
            <div class="summary-header">
                <div class="summary-title">Facility Summary</div> <div class="summary-badge" id="system-status">Live</div>
            </div>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">Active Tanks</div>
                    <div class="summary-value" id="sidebar-active-tanks">21</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Hot Tanks (50C)</div>
                    <div class="summary-value small" id="sidebar-hot-tanks">0</div>
                </div>
            </div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <div id="connection-status" style="display: flex; align-items: center; gap: 8px; color: #6b7280;">
                    <i class='bx bx-wifi'></i>
                    <span style="font-size: 13px;">Connecting to Supabase...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-nav">
            <div class="nav-left">
                <div class="nav-toggle" id="sidebar-toggle">
                    <i class='bx bx-menu'></i>
                </div>
                <div class="page-title">FIMA Tank Monitoring System</div>
            </div>
            <div class="nav-right">
                <button class="nav-btn" id="realtime-toggle">
                    <i class='bx bx-wifi'></i>
                    <span>Live Updates</span>
                </button>
                <button class="nav-btn" id="manual-refresh">
                    <i class='bx bx-refresh'></i>
                    <span>Refresh</span>
                </button>
                <button class="nav-btn" id="edit-positions-btn" style="display: none;">
                    <i class='bx bx-map-pin'></i>
                    <span>Edit Tank Positions</span>
                </button>
                <button class="nav-btn" id="theme-toggle">
                    <i class='bx bx-moon'></i>
                    <span>Dark Mode</span>
                </button>
            </div>
        </div>

        <div class="dashboard-content">
            <div class="alert-banner" id="realtime-alert" style="display: none;">
                <i class='bx bx-bell-ring'></i>
                <span>Live updates enabled. New data will appear automatically.</span>
                <button class="alert-close" onclick="closeRealtimeAlert()">
                    <i class='bx bx-x'></i>
                </button>
            </div>

            <div class="location-card">
                <div class="location-icon">
                    <i class='bx bx-map'></i>
                </div>
                <div>
                    <div style="font-weight: 600; color: #111827;">Tanjung Langsat Terminal</div>
                    <div style="font-size: 14px; color: #6b7280; margin-top: 2px;">Real-time tank temperature monitoring - Chemical Storage Facility</div>
                </div>
                <div class="site-badge">Site ID: TLT-2024</div>
            </div>

            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="avg-temp">--</div>
                            <div class="stat-unit">C</div>
                        </div>
                        <div class="stat-icon">
                            <i class='bx bx-trending-up'></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h4><i class='bx bx-thermometer'></i> Average Temperature</h4>
                        <p>All 21 Tanks</p>
                        <div class="stat-trend" id="avg-trend">
                            <i class='bx bx-minus'></i>
                            </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="max-temp">--</div>
                            <div class="stat-unit">C</div>
                        </div>
                        <div class="stat-icon">
                            <i class='bx bx-up-arrow-alt'></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h4><i class='bx bx-chevron-up'></i> Highest Temp</h4>
                        <p id="max-tank">Tank --</p>
                        <div class="stat-trend" id="max-time">--</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="min-temp">--</div>
                            <div class="stat-unit">C</div>
                        </div>
                        <div class="stat-icon">
                            <i class='bx bx-down-arrow-alt'></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h4><i class='bx bx-chevron-down'></i> Lowest Temp</h4>
                        <p id="min-tank">Tank --</p>
                        <div class="stat-trend" id="min-time">--</div>
                    </div>
                </div>
                
                <div class="stat-card status-normal">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="normal-tanks">--</div>
                            <div class="stat-unit">Tanks</div>
                        </div>
                        <div class="stat-icon">
                            <i class='bx bx-check-circle'></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h4><i class='bx bx-shield'></i> Normal Tanks</h4>
                        <p>Below 50C</p>
                        <div class="stat-trend" id="normal-percent">--%</div>
                    </div>
                </div>
                
                <div class="stat-card status-warning">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="warning-tanks">--</div>
                            <div class="stat-unit">Tanks</div>
                        </div>
                        <div class="stat-icon">
                            <i class='bx bx-error-circle'></i>
                        </div>
                    </div>
                    <div class="stat-content">
                        <h4><i class='bx bx-alarm'></i> Hot Tanks</h4>
                        <p>Above 50C</p>
                        <div class="stat-trend" id="warning-percent">--%</div>
                    </div>
                </div>
            </div>

            <div class="map-section">
                <div class="map-section-header">
                    <h3><i class='bx bx-map'></i> Tank Locations Map</h3>
                    <div class="map-controls">
                        <button class="map-btn" id="refresh-map">
                            <i class='bx bx-refresh'></i> Refresh Map
                        </button>
                        <button class="map-btn" id="center-map">
                            <i class='bx bx-target-lock'></i> Center
                        </button>
                        <button class="map-btn" id="toggle-markers">
                            <i class='bx bx-show'></i> Show All
                        </button>

                    </div>
                </div>
                <div class="map-container">
                    <div id="map"></div>
                    
                    <div class="map-stats-card">
                        <div class="map-stats-header">
                            <h4><i class='bx bx-stats'></i> Temperature Statistics</h4>
                            <div id="stats-live-badge" style="font-size: 13px; color: #6b7280; background: rgba(107, 114, 128, 0.1); padding: 6px 12px; border-radius: 20px;">
                                <i class='bx bx-refresh'></i> Updated
                            </div>
                        </div>
                        <div class="map-stats-grid">
                            <div class="map-stat-item">
                                <div class="map-stat-label">
                                    <i class='bx bx-thermometer'></i>
                                    Avg Temperature
                                </div>
                                <div class="map-stat-value">--<span class="map-stat-unit">C</span></div>
                                <div class="map-stat-trend">
                                    <i class='bx bx-minus'></i>
                                    <span>All Tanks</span>
                                </div>
                            </div>
                            <div class="map-stat-item">
                                <div class="map-stat-label">
                                    <i class='bx bx-down-arrow-alt'></i>
                                    Min Temperature
                                </div>
                                <div class="map-stat-value">--<span class="map-stat-unit">C</span></div>
                                <div class="map-stat-trend">
                                    <span id="map-stat-min-tank">Tank --</span>
                                </div>
                            </div>
                            <div class="map-stat-item">
                                <div class="map-stat-label">
                                    <i class='bx bx-data'></i>
                                    Standard Deviation
                                </div>
                                <div class="map-stat-value">--<span class="map-stat-unit"></span></div>
                                <div class="map-stat-trend">
                                    <span>Data Consistency</span>
                                </div>
                            </div>
                            <div class="map-stat-item">
                                <div class="map-stat-label">
                                    <i class='bx bx-up-arrow-alt'></i>
                                    Max Temperature
                                </div>
                                <div class="map-stat-value" id="map-stat-max">--<span class="map-stat-unit">C</span></div>
                                <div class="map-stat-trend">
                                    <span id="map-stat-max-tank">Tank --</span>
                                </div>
                            </div>
                            <div class="map-stat-item">
                                <div class="map-stat-label">
                                    <i class='bx bx-line-chart'></i>
                                    Temperature Range
                                </div>
                                <div class="map-stat-value" id="map-stat-range">--<span class="map-stat-unit">C</span></div>
                                <div class="map-stat-trend">
                                    <i class='bx bx-line-chart'></i>
                                    <span>Variance</span>
                                </div>
                            </div>
                            <div class="map-stat-item">
                                <div class="map-stat-label">
                                    <i class='bx bx-history'></i>
                                    Total Readings
                                </div>
                                <div class="map-stat-value" id="map-stat-total">--<span class="map-stat-unit"></span></div>
                                <div class="map-stat-trend">
                                    <span>Database Records</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280; text-align: center;">
                            <i class='bx bx-info-circle'></i>
                            <span>Based on current 21 tank readings</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="chat-widget">
        <div class="chat-window" id="chat-window">
            <div class="chat-header">
                <i class='bx bxs-bot' style="font-size: 24px;"></i>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 15px;">FIMA AI Assistant</div>
                    <div style="font-size: 11px; opacity: 0.8;">Always active  Dashboard Expert</div>
                </div>
                <i class='bx bx-x' style="cursor: pointer; font-size: 24px;" id="close-chat"></i>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="message bot">
                    Hello! I am your FIMA Bulking Assistant. I have access to your live tank data. How can I help you today?
                </div>
            </div>
            <form class="chat-input-area" id="chat-form">
                <input type="text" class="chat-input" id="chat-input" placeholder="Ask about tank temperatures..." autocomplete="off">
                <button type="submit" class="chat-send">
                    <i class='bx bxs-send'></i>
                </button>
            </form>
        </div>
        <div class="chat-button" id="chat-toggle">
            <i class='bx bxs-message-dots'></i>
        </div>
    </div>

    <div class="position-editor" id="position-editor">
        <div class="position-editor-content">
            <div class="position-editor-header">
                <h3><i class='bx bx-map-pin'></i> Tank Position Editor</h3>
                <div style="display: flex; gap: 10px;">
                    <button id="save-positions" style="padding: 8px 16px; background: white; color: #4f46e5; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                        Save Positions
                    </button>
                    <button id="close-editor" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class='bx bx-x'></i>
                    </button>
                </div>
            </div>
            <div class="position-editor-body">
                <div id="position-map" class="position-editor-map"></div>
                <div class="position-editor-sidebar">
                    <div class="position-controls">
                        <h4 style="margin: 0 0 12px 0;">Instructions</h4>
                        <div class="position-instructions">
                            <p><strong>How to position tanks:</strong></p>
                            <ul>
                                <li>Select a tank from the list below</li>
                                <li>Click on the map where you want to place it</li>
                                <li>Repeat for all 21 tanks</li>
                                <li>Drag markers to fine-tune positions</li>
                                <li>Click "Save Positions" when done</li>
                            </ul>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; gap: 10px;">
                                <button id="reset-positions" style="flex: 1; padding: 10px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; color: #6b7280; cursor: pointer;">
                                    Reset All
                                </button>
                                <button id="auto-arrange" style="flex: 1; padding: 10px; background: #4f46e5; border: none; border-radius: 6px; color: white; cursor: pointer;">
                                    Auto Arrange
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 0 0 12px 0;">Tank Positions</h4>
                    <div class="tank-position-list" id="tank-position-list">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div class="position-save-confirmation" id="position-save-confirmation">
        <i class='bx bx-check-circle'></i>
        <span>Tank positions saved successfully!</span>
    </div>

    <div class="modal-overlay" id="tank-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3><i class='bx bx-thermometer'></i> Tank Temperature Details</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i class='bx bx-x'></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="tank-detail-content">
                    <div class="detail-header">
                        <h2 id="modal-tank-id">Tank --</h2>
                        <div class="tank-temp-large">
                            <span id="modal-tank-temp">--</span>
                            <span class="unit">C</span>
                        </div>
                        <div class="tank-status-badge-large" id="modal-tank-status">--</div>
                        <div class="temp-indicator" id="modal-temp-trend">
                            <i class='bx bx-minus'></i>
                            <span>Temperature stable</span>
                        </div>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-grid-item">
                            <i class='bx bx-calendar'></i>
                            <label>Last Updated</label>
                            <span id="modal-last-update">--</span>
                        </div>
                        <div class="detail-grid-item">
                            <i class='bx bx-trending-up'></i>
                            <label>24h Trend</label>
                            <span id="modal-24h-trend">--C</span>
                        </div>
                        <div class="detail-grid-item">
                            <i class='bx bx-history'></i>
                            <label>Update Count</label>
                            <span id="modal-update-count">--</span>
                        </div>
                        <div class="detail-grid-item">
                            <i class='bx bx-up-arrow-alt'></i>
                            <label>Max Recorded Temp</label>
                            <span id="modal-max-temp">--C</span>
                        </div>
                        <div class="detail-grid-item">
                            <i class='bx bx-down-arrow-alt'></i>
                            <label>Min Recorded Temp</label>
                            <span id="modal-min-temp">--C</span>
                        </div>
                    </div>
                    
                    <div class="date-range-section">
                        <div class="date-range-title">
                            <i class='bx bx-calendar-alt'></i>
                            Select Date Range
                        </div>
                        
                        <div class="date-selector-simple">
                            <div class="date-row">
                                <div class="date-label">Start Date:</div>
                                <div class="date-input-group">
                                    <input type="date" id="start-date" class="date-input" value="">
                                    <button class="date-btn" onclick="setDateRange('today')">
                                        <i class='bx bx-calendar'></i> Today
                                    </button>
                                </div>
                            </div>
                            
                            <div class="date-row">
                                <div class="date-label">End Date:</div>
                                <div class="date-input-group">
                                    <input type="date" id="end-date" class="date-input" value="">
                                    <button class="date-btn" onclick="setDateRange('yesterday')">
                                        <i class='bx bx-arrow-back'></i> Yesterday
                                    </button>
                                </div>
                            </div>
                            
                            <div class="quick-select-buttons">
                                <button class="quick-select-btn active" onclick="setDateRange('7days')">
                                    Last 7 Days
                                </button>
                                <button class="quick-select-btn" onclick="setDateRange('30days')">
                                    Last 30 Days
                                </button>
                                <button class="quick-select-btn" onclick="setDateRange('90days')">
                                    Last 90 Days
                                </button>
                                <button class="quick-select-btn" onclick="setDateRange('thisMonth')">
                                    This Month
                                </button>
                                <button class="quick-select-btn" onclick="setDateRange('lastMonth')">
                                    Last Month
                                </button>
                            </div>
                            
                            <div class="selected-date-display" id="selected-date-display">
                                <i class='bx bx-info-circle'></i>
                                <div class="selected-date-text">
                                    Showing data from <strong id="display-start-date">--</strong> to <strong id="display-end-date">--</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-controls">
                        <div class="chart-control-group">
                            <label for="chart-period"><i class='bx bx-time'></i> Period:</label>
                            <select id="chart-period" class="chart-control-select">
                                <option value="hourly">Hourly</option>
                                <option value="daily" selected>Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="minute">Minute (for single day)</option>
                            </select>
                        </div>
                        <div class="chart-control-group">
                            <label for="chart-type-modal"><i class='bx bx-line-chart'></i> Chart Type:</label>
                            <select id="chart-type-modal" class="chart-control-select">
                                <option value="line" selected>Line Chart</option>
                                <option value="bar">Bar Chart</option>
                                <option value="scatter">Scatter Plot</option>
                            </select>
                        </div>
                        
                    </div>
                    
                    <div class="data-info">
                        <i class='bx bx-info-circle'></i>
                        <span id="chart-data-range">Showing data for: Last 7 days</span>
                        <span style="margin-left: auto;" id="chart-point-count">0 data points</span>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="tank-detail-chart"></canvas>
                        <div class="chart-loading" id="chart-loading" style="display: none;">
                            <i class='bx bx-loader-circle bx-spin'></i>
                            <span>Loading chart data...</span>
                        </div>
                    </div>
                    
                    <div class="temperature-values">
                        <div class="temperature-value-item">
                            <div class="temperature-value-label">Average</div>
                            <div class="temperature-value" id="chart-avg">--C</div>
                        </div>
                        <div class="temperature-value-item">
                            <div class="temperature-value-label">Max</div>
                            <div class="temperature-value" id="chart-max">--C</div>
                        </div>
                        <div class="temperature-value-item">
                            <div class="temperature-value-label">Min</div>
                            <div class="temperature-value" id="chart-min">--C</div>
                        </div>
                        <div class="temperature-value-item">
                            <div class="temperature-value-label">Range</div>
                            <div class="temperature-value" id="chart-range">--C</div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn secondary" onclick="closeModal()">
                            <i class='bx bx-x'></i> Close
                        </button>
                        <button class="modal-btn primary" onclick="exportTankChart()">
                            <i class='bx bx-download'></i> Export Chart
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Main JavaScript - CONNECTS TO SUPABASE DATABASE WITH VISUAL POSITION EDITOR
        (function() {
            // Global variables
            let realtimeEnabled = true;
            let map = null;
            let markers = [];
            let currentData = [];
            let autoRefreshInterval = null;
            let tankDetailChart = null;
            let supabaseClient = null;
            let currentChartType = 'line';
            let currentTankId = null;
            let allTankHistory = [];
            let currentStartDate = null;
            let currentEndDate = null;
            let chartPeriod = 'daily';
            
            let chartRawData = []; // Store raw data for tooltips

            // Position Editor Variables
            let positionMap = null;
            let positionMarkers = [];
            let selectedTankId = null;
            let tankPositions = []; // Array to store all tank positions

            // ADDED: Dragging state for main map markers
            let isDraggingEnabled = false;
            let draggedMarkers = new Map(); // Track which markers have been moved

            // Supabase Configuration
            const SUPABASE_CONFIG = {
                url: 'https://zhjzbvghigeuarxvucob.supabase.co',
                key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoanpidmdoaWdldWFyeHZ1Y29iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NzAxOTUsImV4cCI6MjA4MDM0NjE5NX0.TF0dz6huz6tPAiXe3pz04Fuafh7dewIVNqWpOzJbm2w'
            };

            // Temperature thresholds
            const TEMP_THRESHOLDS = {
                NORMAL: 50, // Below 50C = Normal
                WARNING: 50, // 50C and above = Hot/Warning
                DANGER: 60  // Above 60C = Critical
            };

            // FIMA Bulking Services Coordinates - CENTERED ON TANKS
            const FIMA_COORDINATES = {
                lat: 1.4562,  // Latitude centered on tanks
                lng: 103.9960 // Longitude centered on tanks
            };

            // Initialize default tank positions (HARDCODED)
            function initializeTankPositions() {
                // FIXED: Hardcoded coordinates for 21 tanks
                const fixedPositions = [
                    { id: 1, lat: 1.456165, lng: 103.996625, zone: "FIMA Terminal" },
                    { id: 2, lat: 1.455870, lng: 103.996528, zone: "FIMA Terminal" },
                    { id: 3, lat: 1.455612, lng: 103.996405, zone: "FIMA Terminal" },
                    { id: 4, lat: 1.455350, lng: 103.996298, zone: "FIMA Terminal" },
                    { id: 5, lat: 1.455071, lng: 103.996174, zone: "FIMA Terminal" },
                    { id: 6, lat: 1.456588, lng: 103.996480, zone: "FIMA Terminal" },
                    { id: 7, lat: 1.456277, lng: 103.996335, zone: "FIMA Terminal" },
                    { id: 8, lat: 1.456020, lng: 103.996233, zone: "FIMA Terminal" },
                    { id: 9, lat: 1.455752, lng: 103.996121, zone: "FIMA Terminal" },
                    { id: 10, lat: 1.455478, lng: 103.995992, zone: "FIMA Terminal" },
                    { id: 11, lat: 1.455183, lng: 103.995895, zone: "FIMA Terminal" },
                    { id: 12, lat: 1.456685, lng: 103.996228, zone: "FIMA Terminal" },
                    { id: 13, lat: 1.456385, lng: 103.996072, zone: "FIMA Terminal" },
                    { id: 14, lat: 1.456787, lng: 103.995987, zone: "FIMA Terminal" },
                    { id: 15, lat: 1.456492, lng: 103.995815, zone: "FIMA Terminal" },
                    { id: 16, lat: 1.456889, lng: 103.995734, zone: "FIMA Terminal" },
                    { id: 17, lat: 1.456604, lng: 103.995563, zone: "FIMA Terminal" },
                    { id: 18, lat: 1.456980, lng: 103.995472, zone: "FIMA Terminal" },
                    { id: 19, lat: 1.456685, lng: 103.995305, zone: "FIMA Terminal" },
                    { id: 20, lat: 1.457071, lng: 103.995225, zone: "FIMA Terminal" },
                    { id: 21, lat: 1.456776, lng: 103.995069, zone: "FIMA Terminal" }
                ];
                
                tankPositions = fixedPositions;
                console.log(' Loaded HARDCODED tank positions based on provided coordinates');
            }

            // Save tank positions to localStorage (Legacy function kept for structure)
            function saveTankPositions() {
                // Since we are using hardcoded positions, this function is just a placeholder
                // or for local testing only.
                localStorage.setItem('fima_tank_positions', JSON.stringify(tankPositions));
                console.log(' Saved tank positions to localStorage (Note: Hardcoded positions preferred)');
                
                // Show confirmation message
                const confirmation = document.getElementById('position-save-confirmation');
                if (confirmation) {
                    confirmation.style.display = 'flex';
                    setTimeout(() => {
                        confirmation.style.display = 'none';
                    }, 3000);
                }
            }

            // Get tank location by ID
            function getTankLocation(tankId) {
                const tankPosition = tankPositions.find(tank => tank.id === tankId);
                
                if (tankPosition) {
                    return tankPosition;
                }
                
                // If not found, create a fallback position
                console.warn(`Tank ${tankId} not found in positions, using fallback`);
                return {
                    id: tankId,
                    lat: FIMA_COORDINATES.lat + (Math.random() - 0.5) * 0.002,
                    lng: FIMA_COORDINATES.lng + (Math.random() - 0.5) * 0.002,
                    zone: "Storage Area " + String.fromCharCode(65 + Math.floor((tankId - 1) / 5))
                };
            }

            // Helper function to get zone for modal display
            function getTankZone(tankId) {
                const location = getTankLocation(tankId);
                return location.zone;
            }

            // Number formatting function
            function formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            }

            // Get temperature status
            function getTemperatureStatus(temperature) {
                if (temperature >= TEMP_THRESHOLDS.DANGER) {
                    return {
                        status: 'danger',
                        text: 'Critical',
                        color: '#ef4444',
                        bgColor: 'rgba(239, 68, 68, 0.1)'
                    };
                } else if (temperature >= TEMP_THRESHOLDS.WARNING) {
                    return {
                        status: 'warning',
                        text: 'Hot',
                        color: '#f59e0b',
                        bgColor: 'rgba(245, 158, 11, 0.1)'
                    };
                } else {
                    return {
                        status: 'normal',
                        text: 'Normal',
                        color: '#10b981',
                        bgColor: 'rgba(16, 185, 129, 0.1)'
                    };
                }
            }

            // Initialize dashboard
            async function initDashboard() {
                console.log(' Initializing Tank Monitoring Dashboard...');
                
                // Initialize tank positions
                initializeTankPositions();
                
                // Initialize Supabase
                await initializeSupabase();
                
                // Setup event listeners
                initializeEventListeners();
                
                // Initialize map if element exists
                if (document.getElementById('map')) {
                    initializeMap();
                }
                
                // Load initial data
                await loadInitialData();
                
                // Start realtime updates
                startRealtimeUpdates();
                
                // Initialize AI Chatbot
                initChatbot();

                console.log(' Dashboard initialized');
            }

            // Initialize AI Chatbot
            function initChatbot() {
                const toggle = document.getElementById('chat-toggle');
                const close = document.getElementById('close-chat');
                const win = document.getElementById('chat-window');
                const form = document.getElementById('chat-form');
                const input = document.getElementById('chat-input');
                const messages = document.getElementById('chat-messages');

                toggle.onclick = () => win.style.display = 'flex';
                close.onclick = () => win.style.display = 'none';

                // FIND THIS SECTION IN YOUR index.html
            form.onsubmit = async (e) => {
                e.preventDefault();
    
                // 1. Capture ONLY what the user typed
                const userMessage = input.value.trim();
                if (!userMessage) return;

                // 2. Display ONLY that short message in the blue bubble
                appendMessage('user', userMessage);
                input.value = '';

                const typingId = appendMessage('bot', 'AI is thinking...');

                try {
                    // 3. Prepare the dashboard data SILENTLY (not shown on screen)
                    const avgTemp = document.getElementById('avg-temp').innerText;
                    const tankSummary = currentData.map(t => `T${t.tank_id}: ${t.temperature.toFixed(1)}C`).join(', ');
        
                    // 4. Send the short message AND the hidden data to the backend
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: userMessage, // Just "hi"
                            contextData: `Avg Temp: ${avgTemp}. Tank Details: ${tankSummary}` // Hidden background data
                        })
                    });

                    const data = await response.json();
                    updateMessage(typingId, data.reply || data.error);
                } catch (err) {
                    updateMessage(typingId, "Error: Could not reach the AI server.");
                }
            };

                function appendMessage(type, text) {
                    const id = Date.now();
                    const div = document.createElement('div');
                    div.className = `message ${type}`;
                    div.id = `msg-${id}`;
                    div.innerText = text;
                    messages.appendChild(div);
                    messages.scrollTop = messages.scrollHeight;
                    return id;
                }

                function updateMessage(id, text) {
                    const msg = document.getElementById(`msg-${id}`);
                    if (msg) {
                        // Clean any unexpected characters
                        msg.innerText = text; 
                    }
                    const messagesContainer = document.getElementById('chat-messages');
                    essagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            // Initialize Supabase client
            async function initializeSupabase() {
                try {
                    if (!window.supabase) {
                        console.error('Supabase library not loaded');
                        updateConnectionStatus('Supabase library not loaded', 'error');
                        return;
                    }
                    
                    supabaseClient = window.supabase.createClient(
                        SUPABASE_CONFIG.url,
                        SUPABASE_CONFIG.key
                    );
                    
                    console.log(' Supabase client initialized');
                    updateConnectionStatus('Connected to Supabase', 'success');
                    
                    // Test connection
                    await testSupabaseConnection();
                    
                } catch (error) {
                    console.error('Failed to initialize Supabase:', error);
                    updateConnectionStatus('Connection failed: ' + error.message, 'error');
                }
            }

            // Test Supabase connection
            async function testSupabaseConnection() {
                try {
                    const { data, error } = await supabaseClient
                        .from('tank_readings')
                        .select('count')
                        .limit(1);
                    
                    if (error) {
                        throw error;
                    }
                    
                    console.log(' Supabase connection test successful');
                    return true;
                } catch (error) {
                    console.error('Supabase connection test failed:', error);
                    updateConnectionStatus('Database error: ' + error.message, 'error');
                    return false;
                }
            }

            // Update connection status display
            function updateConnectionStatus(message, type) {
                const statusElement = document.getElementById('connection-status');
                if (!statusElement) return;
                
                const icon = statusElement.querySelector('i');
                const text = statusElement.querySelector('span');
                
                if (!icon || !text) return;
                
                text.textContent = message;
                
                switch(type) {
                    case 'success':
                        statusElement.style.color = '#10b981';
                        icon.className = 'bx bx-check-circle';
                        break;
                    case 'error':
                        statusElement.style.color = '#ef4444';
                        icon.className = 'bx bx-error-circle';
                        break;
                    default:
                        statusElement.style.color = '#6b7280';
                        icon.className = 'bx bx-wifi';
                }
            }

            // Initialize event listeners
            function initializeEventListeners() {
                // Sidebar toggle
                const sidebarToggle = document.getElementById('sidebar-toggle');
                const mobileOverlay = document.getElementById('mobile-overlay');
                
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', toggleSidebar);
                }
                
                if (mobileOverlay) {
                    mobileOverlay.addEventListener('click', toggleSidebar);
                }
                
                // Realtime toggle
                const realtimeToggle = document.getElementById('realtime-toggle');
                if (realtimeToggle) {
                    realtimeToggle.addEventListener('click', toggleRealtime);
                }
                
                // Manual refresh
                const manualRefresh = document.getElementById('manual-refresh');
                if (manualRefresh) {
                    manualRefresh.addEventListener('click', function() {
                        loadInitialData();
                    });
                }
                
                // Theme toggle
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', toggleTheme);
                }
                
                // Position editor button
                const editPositionsBtn = document.getElementById('edit-positions-btn');
                if (editPositionsBtn) {
                    editPositionsBtn.addEventListener('click', openPositionEditor);
                }
                
                // Map controls
                const refreshMapBtn = document.getElementById('refresh-map');
                const centerMapBtn = document.getElementById('center-map');
                const toggleMarkersBtn = document.getElementById('toggle-markers');
                
                if (refreshMapBtn) refreshMapBtn.addEventListener('click', refreshMapData);
                if (centerMapBtn) centerMapBtn.addEventListener('click', centerMap);
                if (toggleMarkersBtn) toggleMarkersBtn.addEventListener('click', toggleAllMarkers);
                
                // Real-time alert close
                const alertClose = document.querySelector('.alert-close');
                if (alertClose) {
                    alertClose.addEventListener('click', closeRealtimeAlert);
                }
                
                // Chart controls in modal
                const chartPeriodSelect = document.getElementById('chart-period');
                const chartTypeSelect = document.getElementById('chart-type-modal');
                
                
                if (chartPeriodSelect) {
                    chartPeriodSelect.addEventListener('change', function() {
                        chartPeriod = this.value;
                        updateChartWithCurrentSettings();
                    });
                }
                
                if (chartTypeSelect) {
                    chartTypeSelect.addEventListener('change', function() {
                        currentChartType = this.value;
                        updateChartWithCurrentSettings();
                    });
                }
                
                // Date input listeners
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                
                if (startDateInput) {
                    startDateInput.addEventListener('change', updateDateRangeFromInputs);
                }
                
                if (endDateInput) {
                    endDateInput.addEventListener('change', updateDateRangeFromInputs);
                }
            }

            // Toggle dragging functionality
            function toggleDragging() {
                isDraggingEnabled = !isDraggingEnabled;
                const toggleBtn = document.getElementById('toggle-drag');
                
                if (isDraggingEnabled) {
                    toggleBtn.innerHTML = '<i class="bx bx-check"></i> Dragging Enabled';
                    toggleBtn.style.background = '#4f46e5';
                    toggleBtn.style.color = 'white';
                    enableMarkerDragging();
                    showNotification('Tank dragging enabled. Drag any tank to reposition it.', 'info');
                } else {
                    toggleBtn.innerHTML = '<i class="bx bx-move"></i> Enable Dragging';
                    toggleBtn.style.background = '';
                    toggleBtn.style.color = '';
                    disableMarkerDragging();
                    showNotification('Tank dragging disabled.', 'info');
                }
            }

            // Enable dragging for map markers
            function enableMarkerDragging() {
                markers.forEach(marker => {
                    marker.dragging.enable();
                    marker.options.draggable = true;
                    
                    // Add dragend event to save position
                    marker.off('dragend');
                    marker.on('dragend', function(e) {
                        const tankId = marker.tankId;
                        const newLatLng = e.target.getLatLng();
                        
                        // Update tank position
                        updateTankPositionInArray(tankId, newLatLng.lat, newLatLng.lng);
                        
                        // Mark as dragged
                        draggedMarkers.set(tankId, true);
                        
                        // Show save prompt
                        showNotification(`Tank ${tankId} moved. Don't forget to save positions!`, 'warning');
                    });
                    
                    // Update marker style to show it's draggable
                    if (marker._icon) {
                        marker._icon.classList.add('leaflet-marker-draggable');
                        marker._icon.style.cursor = 'move';
                    }
                });
            }

            // Disable dragging for map markers
            function disableMarkerDragging() {
                markers.forEach(marker => {
                    marker.dragging.disable();
                    marker.options.draggable = false;
                    
                    if (marker._icon) {
                        marker._icon.classList.remove('leaflet-marker-draggable');
                        marker._icon.style.cursor = '';
                    }
                });
            }

            // Update tank position in array when dragged
            function updateTankPositionInArray(tankId, lat, lng) {
                const tankIndex = tankPositions.findIndex(tank => tank.id === tankId);
                
                if (tankIndex !== -1) {
                    tankPositions[tankIndex].lat = lat;
                    tankPositions[tankIndex].lng = lng;
                }
            }

            // Show notification
            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = 'position-save-confirmation';
                notification.id = 'dragging-notification';
                notification.style.display = 'flex';
                notification.style.alignItems = 'center';
                notification.style.gap = '10px';
                notification.style.padding = '12px 20px';
                notification.style.borderRadius = '8px';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '100000';
                notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                
                // Set color based on type
                if (type === 'info') {
                    notification.style.background = '#3b82f6';
                    notification.style.color = 'white';
                    notification.innerHTML = `<i class='bx bx-info-circle'></i><span>${message}</span>`;
                } else if (type === 'warning') {
                    notification.style.background = '#f59e0b';
                    notification.style.color = 'white';
                    notification.innerHTML = `<i class='bx bx-error-circle'></i><span>${message}</span>`;
                } else if (type === 'success') {
                    notification.style.background = '#10b981';
                    notification.style.color = 'white';
                    notification.innerHTML = `<i class='bx bx-check-circle'></i><span>${message}</span>`;
                }
                
                // Remove existing notification
                const existingNotif = document.getElementById('dragging-notification');
                if (existingNotif) {
                    existingNotif.remove();
                }
                
                // Add to document
                document.body.appendChild(notification);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.3s';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, 3000);
            }

            // Open position editor
            function openPositionEditor() {
                const positionEditor = document.getElementById('position-editor');
                if (!positionEditor) return;
                
                positionEditor.style.display = 'flex';
                initializePositionEditor();
            }

            // Initialize position editor
            function initializePositionEditor() {
                // Initialize the position editor map if not already done
                if (!positionMap) {
                    positionMap = L.map('position-map').setView([FIMA_COORDINATES.lat, FIMA_COORDINATES.lng], 17);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(positionMap);
                    
                    // Add click event to map
                    positionMap.on('click', function(e) {
                        if (selectedTankId) {
                            placeTankMarker(selectedTankId, e.latlng.lat, e.latlng.lng);
                        } else {
                            alert('Please select a tank from the list first!');
                        }
                    });
                }
                
                // Clear existing markers
                positionMarkers.forEach(marker => positionMap.removeLayer(marker));
                positionMarkers = [];
                
                // Add markers for all tanks
                tankPositions.forEach(tank => {
                    placeTankMarker(tank.id, tank.lat, tank.lng);
                });
                
                // Update the tank list in sidebar
                updateTankPositionList();
                
                // Add event listeners for position editor buttons
                const savePositionsBtn = document.getElementById('save-positions');
                const closeEditorBtn = document.getElementById('close-editor');
                const resetPositionsBtn = document.getElementById('reset-positions');
                const autoArrangeBtn = document.getElementById('auto-arrange');
                
                if (savePositionsBtn) {
                    savePositionsBtn.onclick = function() {
                        saveTankPositions();
                        // Also disable dragging on main map after save
                        isDraggingEnabled = false;
                        const toggleBtn = document.getElementById('toggle-drag');
                        if (toggleBtn) {
                            toggleBtn.innerHTML = '<i class="bx bx-move"></i> Enable Dragging';
                            toggleBtn.style.background = '';
                            toggleBtn.style.color = '';
                        }
                        disableMarkerDragging();
                        closePositionEditor();
                    };
                }
                
                if (closeEditorBtn) {
                    closeEditorBtn.onclick = closePositionEditor;
                }
                
                if (resetPositionsBtn) {
                    resetPositionsBtn.onclick = function() {
                        // Reset function modified for hardcoded version
                        alert('Positions are currently hardcoded and cannot be reset to random.');
                    };
                }
                
                if (autoArrangeBtn) {
                    autoArrangeBtn.onclick = function() {
                         alert('Auto-arrange disabled for hardcoded positions.');
                    };
                }
            }

            // Place a tank marker in position editor
            function placeTankMarker(tankId, lat, lng) {
                // Remove existing marker for this tank
                const existingMarker = positionMarkers.find(marker => marker.tankId === tankId);
                if (existingMarker) {
                    positionMap.removeLayer(existingMarker);
                    positionMarkers = positionMarkers.filter(marker => marker.tankId !== tankId);
                }
                
                // Create new marker
                const marker = L.marker([lat, lng], {
                    draggable: true,
                    autoPan: true
                }).addTo(positionMap);
                
                marker.tankId = tankId;
                
                // Set marker icon with tank number
                marker.setIcon(L.divIcon({
                    html: `<div style="background: #4f46e5; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${tankId}</div>`,
                    className: 'position-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                }));
                
                // Add drag end event
                marker.on('dragend', function(e) {
                    const newLatLng = e.target.getLatLng();
                    updateTankPosition(tankId, newLatLng.lat, newLatLng.lng);
                    updateTankPositionListItem(tankId);
                });
                
                // Add click event to select tank
                marker.on('click', function() {
                    selectTank(tankId);
                });
                
                positionMarkers.push(marker);
                
                // Update tank position in array
                updateTankPosition(tankId, lat, lng);
                
                // Update the list item
                updateTankPositionListItem(tankId);
                
                // Select this tank
                selectTank(tankId);
            }

            // Update tank position in array
            function updateTankPosition(tankId, lat, lng) {
                const tankIndex = tankPositions.findIndex(tank => tank.id === tankId);
                
                if (tankIndex !== -1) {
                    tankPositions[tankIndex].lat = lat;
                    tankPositions[tankIndex].lng = lng;
                } else {
                    tankPositions.push({
                        id: tankId,
                        lat: lat,
                        lng: lng,
                        zone: "Storage Area " + String.fromCharCode(65 + Math.floor((tankId - 1) / 5))
                    });
                }
            }

            // Update tank position list in sidebar
            function updateTankPositionList() {
                const listContainer = document.getElementById('tank-position-list');
                if (!listContainer) return;
                
                listContainer.innerHTML = '';
                
                tankPositions.forEach(tank => {
                    const item = document.createElement('div');
                    item.className = 'tank-position-item';
                    item.dataset.tankId = tank.id;
                    
                    if (selectedTankId === tank.id) {
                        item.classList.add('active');
                    }
                    
                    item.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 24px; height: 24px; background: #4f46e5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${tank.id}</div>
                            <span>Tank ${tank.id}</span>
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                            ${tank.lat.toFixed(6)}, ${tank.lng.toFixed(6)}
                        </div>
                    `;
                    
                    item.addEventListener('click', function() {
                        selectTank(tank.id);
                        // Center map on this tank
                        const marker = positionMarkers.find(m => m.tankId === tank.id);
                        if (marker) {
                            positionMap.setView(marker.getLatLng(), positionMap.getZoom());
                        }
                    });
                    
                    listContainer.appendChild(item);
                });
            }

            // Update single tank position list item
            function updateTankPositionListItem(tankId) {
                const item = document.querySelector(`.tank-position-item[data-tank-id="${tankId}"]`);
                if (!item) return;
                
                const tank = tankPositions.find(t => t.id === tankId);
                if (!tank) return;
                
                const coordsDiv = item.querySelector('div:last-child');
                if (coordsDiv) {
                    coordsDiv.textContent = `${tank.lat.toFixed(6)}, ${tank.lng.toFixed(6)}`;
                }
            }

            // Select a tank in position editor
            function selectTank(tankId) {
                selectedTankId = tankId;
                
                // Update all list items
                document.querySelectorAll('.tank-position-item').forEach(item => {
                    item.classList.remove('active');
                    if (parseInt(item.dataset.tankId) === tankId) {
                        item.classList.add('active');
                    }
                });
                
                // Highlight the marker
                positionMarkers.forEach(marker => {
                    if (marker.tankId === tankId) {
                        marker.setIcon(L.divIcon({
                            html: `<div style="background: #ef4444; color: white; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.4);">${tankId}</div>`,
                            className: 'position-marker-selected',
                            iconSize: [45, 45],
                            iconAnchor: [22.5, 45]
                        }));
                    } else {
                        marker.setIcon(L.divIcon({
                            html: `<div style="background: #4f46e5; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${marker.tankId}</div>`,
                            className: 'position-marker',
                            iconSize: [40, 40],
                            iconAnchor: [20, 40]
                        }));
                    }
                });
            }

            // Apply a predefined layout (Disabled for hardcoded)
            function applyLayout(layoutName) {
                 alert('Layouts disabled for hardcoded positions.');
            }

            // Auto arrange tanks in a grid (Disabled for hardcoded)
            function autoArrangeTanks() {
                 alert('Auto-arrange disabled for hardcoded positions.');
            }

            // Reset all tank positions (Disabled for hardcoded)
            function resetTankPositions() {
                 alert('Reset disabled for hardcoded positions.');
            }

            // Close position editor
            function closePositionEditor() {
                const positionEditor = document.getElementById('position-editor');
                if (positionEditor) {
                    positionEditor.style.display = 'none';
                }
                
                // Refresh main map to show updated positions
                if (map && currentData.length > 0) {
                    updateMapMarkers(currentData);
                }
            }

            // Toggle theme
            function toggleTheme() {
                const themeBtn = document.getElementById('theme-toggle');
                const body = document.body;
                
                if (body.classList.contains('dark-theme')) {
                    body.classList.remove('dark-theme');
                    themeBtn.innerHTML = '<i class="bx bx-moon"></i><span>Dark Mode</span>';
                } else {
                    body.classList.add('dark-theme');
                    themeBtn.innerHTML = '<i class="bx bx-sun"></i><span>Light Mode</span>';
                }
            }

            // Set date range with quick buttons
            window.setDateRange = function(rangeType) {
                const today = new Date();
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                const quickSelectButtons = document.querySelectorAll('.quick-select-btn');
                
                if (!startDateInput || !endDateInput) return;
                
                // Update active button
                quickSelectButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                let startDate = new Date();
                let endDate = new Date();
                
                switch(rangeType) {
                    case 'today':
                        startDate = new Date(today);
                        endDate = new Date(today);
                        break;
                    case 'yesterday':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 1);
                        endDate = new Date(startDate);
                        break;
                    case '7days':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 6);
                        endDate = new Date(today);
                        break;
                    case '30days':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 29);
                        endDate = new Date(today);
                        break;
                    case '90days':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 89);
                        endDate = new Date(today);
                        break;
                    case 'thisMonth':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        endDate = new Date(today);
                        break;
                    case 'lastMonth':
                        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                        break;
                    default:
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 6);
                        endDate = new Date(today);
                }
                
                // Format dates for input fields (YYYY-MM-DD)
                const formatDateForInput = (date) => {
                    return date.toISOString().split('T')[0];
                };
                
                startDateInput.value = formatDateForInput(startDate);
                endDateInput.value = formatDateForInput(endDate);
                
                // Update display
                updateDateDisplay(startDate, endDate);
                
                // Update chart
                updateChartWithDateRange(startDate, endDate);
            };

            // Update date range from input fields
            function updateDateRangeFromInputs() {
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                
                if (!startDateInput || !endDateInput) return;
                
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                
                // Validate dates
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    return;
                }
                
                // Make sure start date is before end date
                if (startDate > endDate) {
                    alert('Start date must be before end date');
                    return;
                }
                
                // Update display
                updateDateDisplay(startDate, endDate);
                
                // Update chart
                updateChartWithDateRange(startDate, endDate);
            }

            // Update date display
            function updateDateDisplay(startDate, endDate) {
                const displayStart = document.getElementById('display-start-date');
                const displayEnd = document.getElementById('display-end-date');
                
                if (displayStart && displayEnd) {
                    displayStart.textContent = formatDateForDisplay(startDate);
                    displayEnd.textContent = formatDateForDisplay(endDate);
                }
            }

            // Format date for display
            function formatDateForDisplay(date) {
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // Format timestamp for tooltip - SHOWS DATE AND TIME
            function formatTimestampForTooltip(date) {
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            // Check if date range is a single day
            function isSingleDayRange(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                start.setHours(0, 0, 0, 0);
                end.setHours(0, 0, 0, 0);
                return start.getTime() === end.getTime();
            }

            // Update chart with date range
            function updateChartWithDateRange(startDate, endDate) {
                if (currentTankId && allTankHistory.length > 0) {
                    currentStartDate = startDate;
                    currentEndDate = endDate;
                    
                    // If single day range, automatically switch to minute view for time display
                    if (isSingleDayRange(startDate, endDate)) {
                        const chartPeriodSelect = document.getElementById('chart-period');
                        if (chartPeriodSelect) {
                            chartPeriodSelect.value = 'minute';
                            chartPeriod = 'minute';
                        }
                    }
                    
                    // Filter data based on date range
                    const filteredData = allTankHistory.filter(reading => {
                        const readingDate = new Date(reading.created_at);
                        return readingDate >= startDate && readingDate <= endDate;
                    });
                    
                    // Process and display chart
                    createTankDetailChart(currentTankId, filteredData);
                    
                    // Update statistics
                    updateChartStatistics(filteredData);
                    
                    // Update chart data range info
                    const chartDataRange = document.getElementById('chart-data-range');
                    if (chartDataRange) {
                        const startStr = formatDateForDisplay(startDate);
                        const endStr = formatDateForDisplay(endDate);
                        if (isSingleDayRange(startDate, endDate)) {
                            chartDataRange.textContent = `Showing data for: ${startStr}`;
                        } else {
                            chartDataRange.textContent = `Showing data from ${startStr} to ${endStr}`;
                        }
                    }
                }
            }

            // Update chart with current settings
            function updateChartWithCurrentSettings() {
                if (currentTankId && allTankHistory.length > 0) {
                    // Filter data based on current date range
                    const filteredData = filterDataByDateRange(allTankHistory);
                    
                    // Process and display chart
                    createTankDetailChart(currentTankId, filteredData);
                    
                    // Update statistics
                    updateChartStatistics(filteredData);
                }
            }

            // Filter data by current date range
            function filterDataByDateRange(data) {
                if (!currentStartDate || !currentEndDate) {
                    // Default to last 7 days
                    const today = new Date();
                    currentStartDate = new Date(today);
                    currentStartDate.setDate(today.getDate() - 6);
                    currentEndDate = new Date(today);
                }
                
                return data.filter(reading => {
                    const readingDate = new Date(reading.created_at);
                    return readingDate >= currentStartDate && readingDate <= currentEndDate;
                });
            }

            // Toggle sidebar (Modified for Mobile Overlay)
            function toggleSidebar() {
                const sidebar = document.querySelector('.sidebar-minimalist');
                const overlay = document.getElementById('mobile-overlay');
                
                if (sidebar) {
                    sidebar.classList.toggle('active');
                    
                    // Show/hide overlay on mobile
                    if (window.innerWidth <= 768 && overlay) {
                        if (sidebar.classList.contains('active')) {
                            overlay.style.display = 'block';
                        } else {
                            overlay.style.display = 'none';
                        }
                    }
                }
            }

            // Toggle realtime updates
            function toggleRealtime() {
                realtimeEnabled = !realtimeEnabled;
                const btn = document.getElementById('realtime-toggle');
                
                if (!btn) return;
                
                if (realtimeEnabled) {
                    btn.innerHTML = '<i class="bx bx-wifi"></i><span>Live Updates</span>';
                    btn.classList.add('active');
                    startRealtimeUpdates();
                    showRealtimeAlert();
                } else {
                    btn.innerHTML = '<i class="bx bx-wifi-off"></i><span>Live Updates</span>';
                    btn.classList.remove('active');
                    stopRealtimeUpdates();
                }
            }

            // Initialize Leaflet map
            function initializeMap() {
                if (!L || !document.getElementById('map')) {
                    console.warn('Leaflet not available or map element not found');
                    return;
                }
                
                try {
                    // Center on FIMA Bulking Services exact location
                    map = L.map('map').setView([FIMA_COORDINATES.lat, FIMA_COORDINATES.lng], 17);
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                        maxZoom: 19
                    }).addTo(map);
                    
                    // Add a marker for FIMA Bulking Services
                    L.marker([FIMA_COORDINATES.lat, FIMA_COORDINATES.lng])
                        .addTo(map)
                        .bindPopup('<b>FIMA Bulking Services Berhad</b><br>Tanjung Langsat Terminal<br>Chemical Storage Facility')
                        .openPopup();
                    
                    console.log(' Map initialized with correct FIMA coordinates');
                } catch (error) {
                    console.error('Failed to initialize map:', error);
                }
            }

            // Load initial data from Supabase
            async function loadInitialData() {
                try {
                    if (!supabaseClient) {
                        console.error('Supabase client not initialized');
                        showError('Database connection not established');
                        return;
                    }
                    
                    console.log(' Loading data from Supabase...');
                    
                    // Update UI to show loading state
                    updateLoadingState(true);
                    
                    // 1. Get latest readings for each tank (21 tanks)
                    const latestReadings = await getLatestTankReadings();
                    
                    // 2. Get total count of all readings
                    const totalReadings = await getTotalReadingsCount();
                    
                    // 3. Process and display data
                    await processAndDisplayData(latestReadings, totalReadings);
                    
                    console.log(' Data loaded from Supabase:', {
                        latestReadings: latestReadings.length,
                        totalReadings: totalReadings
                    });
                    
                    // Update UI to show success state
                    updateLoadingState(false);
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    showError('Failed to load data: ' + error.message);
                    updateLoadingState(false);
                }
            }

            // Get latest readings for each tank
            async function getLatestTankReadings() {
                try {
                    // We need to get the latest reading for each of the 21 tanks
                    const readings = [];
                    
                    // Query to get the latest reading for each tank_id
                    const { data, error } = await supabaseClient
                        .from('tank_readings')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        throw error;
                    }
                    
                    if (!data || data.length === 0) {
                        console.log('No readings found in database');
                        return [];
                    }
                    
                    // Group by tank_id and take the latest for each tank
                    const tankMap = new Map();
                    data.forEach(reading => {
                        if (!tankMap.has(reading.tank_id)) {
                            tankMap.set(reading.tank_id, reading);
                        }
                    });
                    
                    // Convert map to array
                    const latestReadings = Array.from(tankMap.values());
                    
                    // If we have less than 21 tanks, create placeholders
                    if (latestReadings.length < 21) {
                        for (let i = 1; i <= 21; i++) {
                            if (!latestReadings.find(r => r.tank_id === i)) {
                                latestReadings.push({
                                    tank_id: i,
                                    temperature: 25.0 + (Math.random() * 15),
                                    created_at: new Date().toISOString(),
                                    tank_name: `Tank ${i}`,
                                    tank_number: i
                                });
                            }
                        }
                    }
                    
                    return latestReadings;
                    
                } catch (error) {
                    console.error('Error getting latest readings:', error);
                    throw error;
                }
            }

            // Get total count of all readings
            async function getTotalReadingsCount() {
                try {
                    const { count, error } = await supabaseClient
                        .from('tank_readings')
                        .select('*', { count: 'exact', head: true });
                    
                    if (error) {
                        throw error;
                    }
                    
                    return count || 0;
                    
                } catch (error) {
                    console.error('Error getting total count:', error);
                    // Return a fallback value
                    return 735; // Fallback to your original number
                }
            }

            // Process and display data
            async function processAndDisplayData(latestReadings, totalReadings) {
                currentData = latestReadings;
                
                // Update summary statistics
                updateSummaryStats(latestReadings);
                
                // Update temperature statistics (beside map)
                updateMapStats(latestReadings, totalReadings);
                
                // Update map markers with SAVED POSITIONS
                updateMapMarkers(latestReadings);
                
                // Update Sidebar Summary
                updateSidebarSummary(latestReadings);
                
                // Update live badge
                updateLiveBadge();
            }

            // Update summary statistics
            function updateSummaryStats(readings) {
                if (!readings || readings.length === 0) {
                    console.log('No readings available');
                    return;
                }
                
                // Calculate average temperature
                const avgTemp = readings.reduce((sum, r) => sum + r.temperature, 0) / readings.length;
                
                // Update the stats cards
                document.getElementById('avg-temp').textContent = avgTemp.toFixed(1);
                
                // Find max and min temperatures
                const maxReading = readings.reduce((max, r) => r.temperature > max.temperature ? r : max);
                const minReading = readings.reduce((min, r) => r.temperature < min.temperature ? r : min);
                
                document.getElementById('max-temp').textContent = maxReading.temperature.toFixed(1);
                document.getElementById('min-temp').textContent = minReading.temperature.toFixed(1);
                document.getElementById('max-tank').textContent = `Tank ${maxReading.tank_id}`;
                document.getElementById('min-tank').textContent = `Tank ${minReading.tank_id}`;
                
                // Count normal and hot tanks
                const normalCount = readings.filter(r => r.temperature < TEMP_THRESHOLDS.NORMAL).length;
                const hotCount = readings.filter(r => r.temperature >= TEMP_THRESHOLDS.WARNING).length;
                const totalTanks = readings.length;
                
                document.getElementById('normal-tanks').textContent = normalCount;
                document.getElementById('warning-tanks').textContent = hotCount;
                
                // Update percentages
                document.getElementById('normal-percent').textContent = `${Math.round((normalCount / totalTanks) * 100)}%`;
                document.getElementById('warning-percent').textContent = `${Math.round((hotCount / totalTanks) * 100)}%`;
                
                // Update system status in sidebar
                const systemStatus = document.getElementById('system-status');
                if (hotCount > 0) {
                    systemStatus.textContent = hotCount + ' Hot';
                    systemStatus.className = 'summary-badge warning';
                    if (readings.some(r => r.temperature >= TEMP_THRESHOLDS.DANGER)) {
                        systemStatus.className = 'summary-badge danger';
                    }
                } else {
                    systemStatus.textContent = 'All Normal';
                    systemStatus.className = 'summary-badge';
                }
            }

            // Update temperature statistics beside map
            function updateMapStats(readings, totalReadings) {
                if (!readings || readings.length === 0) {
                    return;
                }
                
                // Calculate statistics from current readings
                const temps = readings.map(r => r.temperature);
                const avg = temps.reduce((a, b) => a + b, 0) / temps.length;
                const max = Math.max(...temps);
                const min = Math.min(...temps);
                const range = max - min;
                
                // Calculate standard deviation
                const variance = temps.reduce((sum, t) => sum + Math.pow(t - avg, 2), 0) / temps.length;
                const stdDev = Math.sqrt(variance);
                
                // Find max and min tank IDs
                const maxReading = readings.reduce((max, r) => r.temperature > max.temperature ? r : max);
                const minReading = readings.reduce((min, r) => r.temperature < min.temperature ? r : min);
                
                // Update map statistics - ALL VALUES NOW DYNAMIC
                // Get all map stat elements
                const mapStatElements = document.querySelectorAll('.map-stat-value');
                if (mapStatElements.length >= 6) {
                    mapStatElements[0].textContent = avg.toFixed(1); // Avg Temperature
                    mapStatElements[1].textContent = min.toFixed(1); // Min Temperature
                    mapStatElements[2].textContent = stdDev.toFixed(1); // Standard Deviation
                    mapStatElements[3].textContent = max.toFixed(1); // Max Temperature
                    mapStatElements[4].textContent = range.toFixed(1); // Temperature Range
                    mapStatElements[5].textContent = formatNumber(totalReadings); // Total Readings
                }
                
                // Update tank numbers for max and min
                const maxTankElement = document.getElementById('map-stat-max-tank');
                const minTankElement = document.getElementById('map-stat-min-tank');
                
                if (maxTankElement) maxTankElement.textContent = `Tank ${maxReading.tank_id}`;
                if (minTankElement) minTankElement.textContent = `Tank ${minReading.tank_id}`;
                
                // Update live badge
                const liveBadge = document.getElementById('stats-live-badge');
                if (liveBadge) {
                    liveBadge.innerHTML = '<i class="bx bx-refresh bx-spin"></i> Live';
                    liveBadge.style.color = '#10b981';
                    liveBadge.style.background = 'rgba(16, 185, 129, 0.1)';
                }
            }

            // Update Sidebar Summary
            function updateSidebarSummary(readings) {
                try {
                    // Update active tanks
                    const activeTanksElement = document.getElementById('sidebar-active-tanks');
                    if (activeTanksElement) {
                        activeTanksElement.textContent = readings.length > 21 ? 21 : readings.length;
                    }
                    
                    // Update hot tanks count
                    const hotTanksElement = document.getElementById('sidebar-hot-tanks');
                    if (hotTanksElement) {
                        const hotCount = readings.filter(r => r.temperature >= TEMP_THRESHOLDS.WARNING).length;
                        hotTanksElement.textContent = hotCount;
                    }
                } catch (error) {
                    console.error('Error updating sidebar summary:', error);
                }
            }

            // Update live badge
            function updateLiveBadge() {
                // Already updated in updateMapStats
            }

            // Calculate time ago - MODIFIED TO SHOW HOUR AND MINUTE
            function calculateTimeAgo(dateString) {
                try {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                        if (diffHours === 0) {
                            const diffMinutes = Math.floor(diffMs / (1000 * 60));
                            if (diffMinutes === 0) {
                                return 'just now';
                            }
                            return `${diffMinutes}m ago`;
                        }
                        return `${diffHours}h ago`;
                    } else if (diffDays === 1) {
                        return '1d ago';
                    } else {
                        return `${diffDays}d ago`;
                    }
                } catch (e) {
                    return 'recently';
                }
            }

            // NEW FUNCTION: Format time from date to show hour and minute
            function formatTimeFromDate(dateString) {
                try {
                    const date = new Date(dateString);
                    // Format as "HH:MM" (24-hour format)
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    return `${hours}:${minutes}`;
                } catch (e) {
                    return '--:--';
                }
            }

            // Update map markers for ALL 21 TANKS - USING SAVED POSITIONS
            function updateMapMarkers(readings) {
                if (!map || !L) return;
                
                // Clear existing markers
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                
                // Add markers for EACH TANK - USING SAVED POSITIONS
                readings.forEach(reading => {
                    // Get saved position for this tank
                    const tankLocation = getTankLocation(reading.tank_id);
                    const lat = tankLocation.lat;
                    const lng = tankLocation.lng;
                    
                    const temperature = reading.temperature;
                    const tempStatus = getTemperatureStatus(temperature);
                    
                    // Format time for popup
                    const formattedTime = formatTimeFromDate(reading.created_at);
                    
                    // Create custom icon
                    const icon = L.divIcon({
                        html: `
                            <div class="map-marker" style="background: white; border: 2px solid ${tempStatus.color}; border-radius: 50%; width: 55px; height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 3px 10px rgba(0,0,0,0.15); cursor: pointer; transition: all 0.2s ease; font-weight: 600;">
                                <div class="marker-temperature" style="font-weight: 700; font-size: 13px; color: #111827;">${temperature.toFixed(1)}C</div>
                                <div class="marker-label" style="font-size: 10px; color: #6b7280; margin-top: 3px;">Tank ${reading.tank_id}</div>
                            </div>
                        `,
                        className: 'custom-marker',
                        iconSize: [60, 60],
                        iconAnchor: [30, 60]
                    });
                    
                    // REMOVED LOCATION LINE FROM POPUP
                    const marker = L.marker([lat, lng], { 
                        icon: icon,
                        draggable: isDraggingEnabled // ADDED: Make draggable based on state
                    })
                        .addTo(map)
                        .bindPopup(`
                            <div class="map-popup" style="min-width: 220px; padding: 16px;">
                                <h3 style="margin: 0 0 12px 0; color: #111827;">Tank ${reading.tank_id}</h3>
                                <p style="margin: 0 0 8px 0;"><strong>Temperature:</strong> ${temperature.toFixed(1)}C</p>
                                <p style="margin: 0 0 8px 0;"><strong>Status:</strong> <span style="color: ${tempStatus.color}">${tempStatus.text}</span></p>
                                <p style="margin: 0 0 16px 0;"><strong>Last Update:</strong> ${formattedTime}</p>
                                <button onclick="showTankDetails(${reading.tank_id})" style="margin-top: 15px; padding: 8px 16px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; width: 100%; transition: all 0.2s ease; font-weight: 500;">
                                    View Details
                                </button>
                            </div>
                        `);
                    
                    // Store tank ID for reference
                    marker.tankId = reading.tank_id;
                    
                    // ADDED: Add dragend event if dragging is enabled
                    if (isDraggingEnabled) {
                        marker.on('dragend', function(e) {
                            const tankId = reading.tank_id;
                            const newLatLng = e.target.getLatLng();
                            
                            // Update tank position
                            updateTankPositionInArray(tankId, newLatLng.lat, newLatLng.lng);
                            
                            // Mark as dragged
                            draggedMarkers.set(tankId, true);
                            
                            // Show save prompt
                            showNotification(`Tank ${tankId} moved. Don't forget to save positions!`, 'warning');
                        });
                        
                        // Add draggable class
                        if (marker._icon) {
                            marker._icon.classList.add('leaflet-marker-draggable');
                        }
                    }
                    
                    markers.push(marker);
                });
                
                // ADDED: Update dragging state for all markers
                if (isDraggingEnabled) {
                    enableMarkerDragging();
                }
            }

            // Show tank details modal
            window.showTankDetails = async function(tankId) {
                try {
                    if (!supabaseClient) {
                        alert('Database connection not available');
                        return;
                    }
                    
                    currentTankId = tankId;
                    
                    // START the listener BEFORE fetching history so we don't miss the 
                    // gap between the database request and the subscription start.
                    startRealtimeUpdates(); 

                    // Show loading state
                    const chartLoading = document.getElementById('chart-loading');
                    if (chartLoading) chartLoading.style.display = 'flex';
                    
                    // Get tank history from database (all data)
                    const { data: tankHistory, error } = await supabaseClient
                        .from('tank_readings')
                        .select('*')
                        .eq('tank_id', tankId)
                        .order('created_at', { ascending: true });
                    
                    if (error) {
                        throw error;
                    }
                    
                    // Store all history
                    allTankHistory = tankHistory || [];
                    
                    // Update modal content
                    const modalTankId = document.getElementById('modal-tank-id');
                    const modalTankStatus = document.getElementById('modal-tank-status');
                    const modalTankTemp = document.getElementById('modal-tank-temp');
                    const modalLastUpdate = document.getElementById('modal-last-update');
                    const modalUpdateCount = document.getElementById('modal-update-count');
                    const modal24hTrend = document.getElementById('modal-24h-trend');
                    const modalTempTrend = document.getElementById('modal-temp-trend');
                    const modalMaxTemp = document.getElementById('modal-max-temp');
                    const modalMinTemp = document.getElementById('modal-min-temp');
                    
                    if (modalTankId) modalTankId.textContent = `Tank ${tankId}`;
                    
                    // Get latest reading
                    const latestReading = allTankHistory && allTankHistory.length > 0 ? allTankHistory[allTankHistory.length - 1] : null;
                    const temperature = latestReading ? latestReading.temperature : 25.0;
                    const tempStatus = getTemperatureStatus(temperature);
                    
                    if (modalTankStatus) {
                        modalTankStatus.textContent = tempStatus.text;
                        modalTankStatus.className = `tank-status-badge-large status-${tempStatus.status}`;
                    }
                    if (modalTankTemp) modalTankTemp.textContent = temperature.toFixed(1);
                    
                    // Format time for modal - USING NEW FUNCTION
                    if (modalLastUpdate) {
                        const formattedTime = latestReading ? formatTimeFromDate(latestReading.created_at) : '--:--';
                        modalLastUpdate.textContent = formattedTime;
                    }
                    
                    if (modalUpdateCount) modalUpdateCount.textContent = allTankHistory ? allTankHistory.length : '0';
                    
                    // Calculate max and min temperatures
                    if (allTankHistory && allTankHistory.length > 0) {
                        const temps = allTankHistory.map(r => r.temperature);
                        const maxTemp = Math.max(...temps).toFixed(1);
                        const minTemp = Math.min(...temps).toFixed(1);
                        
                        if (modalMaxTemp) modalMaxTemp.textContent = `${maxTemp}C`;
                        if (modalMinTemp) modalMinTemp.textContent = `${minTemp}C`;
                    } else {
                        if (modalMaxTemp) modalMaxTemp.textContent = '--C';
                        if (modalMinTemp) modalMinTemp.textContent = '--C';
                    }
                    
                    // Calculate 24h trend
                    if (allTankHistory && allTankHistory.length > 1) {
                        const now = new Date();
                        const twentyFourHoursAgo = new Date(now - 24 * 60 * 60 * 1000);
                        const recentReadings = allTankHistory.filter(r => new Date(r.created_at) >= twentyFourHoursAgo);
                        
                        if (recentReadings.length > 1) {
                            const oldest = recentReadings[0].temperature;
                            const latest = recentReadings[recentReadings.length - 1].temperature;
                            const trendDiff = latest - oldest;
                            const trendText = trendDiff > 0 ? `+${trendDiff.toFixed(1)}C` : `${trendDiff.toFixed(1)}C`;
                            
                            if (modal24hTrend) modal24hTrend.textContent = trendText;
                            if (modalTempTrend) {
                                const trendIcon = trendDiff > 0 ? 'bx-up-arrow-alt' : trendDiff < 0 ? 'bx-down-arrow-alt' : 'bx-minus';
                                const trendLabel = trendDiff > 0 ? 'Rising' : trendDiff < 0 ? 'Falling' : 'Stable';
                                modalTempTrend.innerHTML = `<i class='bx ${trendIcon}'></i><span>Temperature ${trendLabel.toLowerCase()}</span>`;
                                modalTempTrend.className = `temp-indicator ${trendDiff > 0 ? 'up' : trendDiff < 0 ? 'down' : 'stable'}`;
                            }
                        } else {
                            if (modal24hTrend) modal24hTrend.textContent = 'No 24h data';
                            if (modalTempTrend) {
                                modalTempTrend.innerHTML = '<i class="bx bx-minus"></i><span>No trend data available</span>';
                            }
                        }
                    } else {
                        if (modal24hTrend) modal24hTrend.textContent = 'No trend data';
                        if (modalTempTrend) {
                            modalTempTrend.innerHTML = '<i class="bx bx-minus"></i><span>No trend data available</span>';
                        }
                    }
                    
                    // Set default date range (last 7 days)
                    const today = new Date();
                    const startDate = new Date(today);
                    startDate.setDate(today.getDate() - 6);
                    
                    // Set date inputs
                    const startDateInput = document.getElementById('start-date');
                    const endDateInput = document.getElementById('end-date');
                    
                    if (startDateInput && endDateInput) {
                        startDateInput.value = startDate.toISOString().split('T')[0];
                        endDateInput.value = today.toISOString().split('T')[0];
                    }
                    
                    // Update date display
                    updateDateDisplay(startDate, today);
                    
                    // Show modal
                    const tankModal = document.getElementById('tank-modal');
                    if (tankModal) {
                        tankModal.style.display = 'flex';
                    }
                    
                    // Hide loading
                    if (chartLoading) chartLoading.style.display = 'none';
                    
                    // Load chart data with default range
                    updateChartWithDateRange(startDate, today);
                    
                } catch (error) {
                    console.error('Error loading tank details:', error);
                    alert('Failed to load tank details: ' + error.message);
                    const chartLoading = document.getElementById('chart-loading');
                    if (chartLoading) chartLoading.style.display = 'none';
                }
            };

            // Create tank detail chart
            function createTankDetailChart(tankId, filteredData) {
                const canvas = document.getElementById('tank-detail-chart');
                if (!canvas) return;
                
                // Get context safely
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                
                // Destroy existing chart properly
                if (tankDetailChart) {
                    tankDetailChart.destroy();
                    tankDetailChart = null;
                }
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (!filteredData || filteredData.length === 0) {
                    // Show empty chart message
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data available for the selected date range', canvas.width / 2, canvas.height / 2);
                    
                    // Update point count
                    const pointCount = document.getElementById('chart-point-count');
                    if (pointCount) pointCount.textContent = '0 data points';
                    return;
                }
                
                // Use raw data without aggregation for higher precision but limit points
                // We will sort chronologically
                const sortedHistory = [...filteredData].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                
                // Use the raw ISO string as the label. Chart.js will keep track of it.
                // We will handle the display formatting in the ticks callback.
                const labels = sortedHistory.map(r => r.created_at);
                const temperatures = sortedHistory.map(r => r.temperature);
                
                // Get temperature status for color coding
                const currentTemp = temperatures[temperatures.length - 1] || 0;
                const tempStatus = getTemperatureStatus(currentTemp);
                
                // Create gradient for line chart
                let backgroundColor;
                if (currentChartType === 'line') {
                    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    gradient.addColorStop(0, tempStatus.status === 'danger' ? 
                        'rgba(239, 68, 68, 0.2)' : 
                        tempStatus.status === 'warning' ? 
                        'rgba(245, 158, 11, 0.2)' : 
                        'rgba(16, 185, 129, 0.2)');
                    gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                    backgroundColor = gradient;
                } else {
                    backgroundColor = tempStatus.status === 'danger' ? 
                        'rgba(239, 68, 68, 0.1)' : 
                        tempStatus.status === 'warning' ? 
                        'rgba(245, 158, 11, 0.1)' : 
                        'rgba(16, 185, 129, 0.1)';
                }
                
                tankDetailChart = new Chart(ctx, {
                    type: currentChartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Tank ${tankId} Temperature (C)`,
                            data: temperatures,
                            borderColor: tempStatus.color,
                            backgroundColor: backgroundColor,
                            borderWidth: 2,
                            tension: 0.4,
                            fill: currentChartType === 'line' ? true : false,
                            pointBackgroundColor: tempStatus.color,
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: tempStatus.color,
                            pointHoverBorderWidth: 3,
                            pointRadius: currentChartType === 'line' ? 3 : 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#111827',
                                bodyColor: '#4b5563',
                                borderColor: '#e5e7eb',
                                borderWidth: 1,
                                padding: 12,
                                boxPadding: 6,
                                callbacks: {
                                    title: function(context) {
                                        const date = new Date(context[0].label);
                                        // Display full Date and Time in tooltip
                                        return date.toLocaleString('en-US', { 
                                            month: 'short', 
                                            day: 'numeric', 
                                            year: 'numeric', 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        });
                                    },
                                    label: function(context) {
                                        return `Temperature: ${context.parsed.y.toFixed(1)}C`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Temperature (C)',
                                    color: '#6b7280',
                                    font: { size: 12, weight: '500' }
                                },
                                grid: { color: 'rgba(229, 231, 235, 0.5)' },
                                ticks: {
                                    color: '#6b7280',
                                    font: { size: 11 },
                                    callback: function(value) { return value + 'C'; }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: '#6b7280',
                                    font: { size: 12, weight: '500' }
                                },
                                grid: { display: false },
                                ticks: {
                                    color: '#6b7280',
                                    font: { size: 11 },
                                    maxRotation: 0,
                                    autoSkip: false, // We manually control skip via callback
                                    callback: function(val, index) {
                                        // Get the current label (ISO string)
                                        const currentLabel = this.getLabelForValue(val);
                                        const currentDate = new Date(currentLabel);
                                        const dateStr = currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                                        // Always show the first label
                                        if (index === 0) return dateStr;

                                        // Get the previous label
                                        const prevLabel = this.getLabelForValue(index - 1);
                                        const prevDate = new Date(prevLabel);
                                        const prevDateStr = prevDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                                        // If date has changed, show the new date. Otherwise, hide it.
                                        if (dateStr !== prevDateStr) {
                                            return dateStr;
                                        }
                                        return ''; // Hide duplicate dates
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'nearest'
                        }
                    }
                });
                
                // Update point count
                const pointCount = document.getElementById('chart-point-count');
                if (pointCount) pointCount.textContent = `${temperatures.length} data points`;
            }

            // Aggregate data based on selected period
            function aggregateDataByPeriod(data, period) {
                if (!data || data.length === 0) return [];
                
                const aggregated = [];
                const groups = {};
                
                data.forEach(reading => {
                    const date = new Date(reading.created_at);
                    let key;
                    
                    switch(period) {
                        case 'minute':
                            // For minute view, show exact time
                            key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}-${date.getHours()}-${date.getMinutes()}`;
                            break;
                        case 'hourly':
                            // Group by hour
                            key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}-${date.getHours()}`;
                            break;
                        case 'daily':
                            // Group by day
                            key = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                            break;
                        case 'weekly':
                            // Group by week
                            const weekNumber = Math.floor(date.getDate() / 7);
                            key = `${date.getFullYear()}-${date.getMonth() + 1}-${weekNumber}`;
                            break;
                        default:
                            // Group by day as default
                            key = date.toISOString().split('T')[0];
                    }
                    
                    if (!groups[key]) {
                        groups[key] = {
                            temperatures: [],
                            dates: [],
                            readings: []
                        };
                    }
                    
                    groups[key].temperatures.push(reading.temperature);
                    groups[key].dates.push(date);
                    groups[key].readings.push(reading);
                });
                
                // Calculate averages for each group
                for (const key in groups) {
                    const temps = groups[key].temperatures;
                    const dates = groups[key].dates;
                    
                    const avgTemp = temps.reduce((a, b) => a + b, 0) / temps.length;
                    
                    // Use the middle date of the group for display
                    const sortedDates = dates.sort((a, b) => a - b);
                    const middleDate = sortedDates[Math.floor(sortedDates.length / 2)];
                    
                    aggregated.push({
                        temperature: avgTemp,
                        created_at: middleDate.toISOString(),
                        count: temps.length,
                        minTemp: Math.min(...temps),
                        maxTemp: Math.max(...temps)
                    });
                }
                
                // Sort by date
                return aggregated.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            }

            // Get period label for chart
            function getPeriodLabel() {
                switch(chartPeriod) {
                    case 'minute':
                        return 'Time (Hour:Minute)';
                    case 'hourly':
                        return 'Time (Hourly)';
                    case 'daily':
                        return 'Date (Daily)';
                    case 'weekly':
                        return 'Week (Weekly)';
                    default:
                        return 'Time';
                }
            }

            // Update chart statistics
            function updateChartStatistics(data) {
                if (!data || data.length === 0) {
                    document.getElementById('chart-avg').textContent = '--C';
                    document.getElementById('chart-max').textContent = '--C';
                    document.getElementById('chart-min').textContent = '--C';
                    document.getElementById('chart-range').textContent = '--C';
                    return;
                }
                
                const temps = data.map(r => r.temperature);
                const avg = temps.reduce((a, b) => a + b, 0) / temps.length;
                const max = Math.max(...temps);
                const min = Math.min(...temps);
                const range = max - min;
                
                document.getElementById('chart-avg').textContent = `${avg.toFixed(1)}C`;
                document.getElementById('chart-max').textContent = `${max.toFixed(1)}C`;
                document.getElementById('chart-min').textContent = `${min.toFixed(1)}C`;
                document.getElementById('chart-range').textContent = `${range.toFixed(1)}C`;
            }

            // --- Add this helper function here ---
            async function refreshModalChartData(tankId) {
                const { data, error } = await supabaseClient
                    .from('tank_readings')
                    .select('*')
                    .eq('tank_id', tankId)
                    .order('created_at', { ascending: true });

                if (!error && data) {
                    allTankHistory = data;
                    updateChartWithCurrentSettings();
                    
                    // Update Modal Header UI
                    const latest = data[data.length - 1];
                    if (latest) {
                        document.getElementById('modal-tank-temp').textContent = latest.temperature.toFixed(1);
                        document.getElementById('modal-last-update').textContent = formatTimeFromDate(latest.created_at);
                    }
                }
            }
            
            // Start realtime updates via Supabase Channel (WITH CHART FIX)
            function startRealtimeUpdates() {
                if (!realtimeEnabled || !supabaseClient) return;

                if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                autoRefreshInterval = setInterval(() => { loadInitialData(); }, 30000); 

                const channel = supabaseClient
                    .channel('tank-updates')
                    .on(
                        'postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'tank_readings' },
                        (payload) => {
                            console.log(' Real-time Insert detected:', payload.new);
                
                            // Refresh background summary stats and map
                            loadInitialData();

                            // FIX: If the modal is open for this specific tank, refresh its chart immediately
                            if (currentTankId && payload.new.tank_id === currentTankId) {
                                refreshModalChartData(currentTankId);
                            }
                        }    
                    )
                    .subscribe();
            }

            // Stop realtime updates
            function stopRealtimeUpdates() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                    console.log(' Real-time updates stopped');
                }
            }

            // Show realtime alert
            function showRealtimeAlert() {
                const realtimeAlert = document.getElementById('realtime-alert');
                if (realtimeAlert) {
                    realtimeAlert.style.display = 'flex';
                    setTimeout(() => {
                        if (realtimeAlert) {
                            realtimeAlert.style.display = 'none';
                        }
                    }, 5000);
                }
            }

            // Close realtime alert
            window.closeRealtimeAlert = function() {
                const realtimeAlert = document.getElementById('realtime-alert');
                if (realtimeAlert) {
                    realtimeAlert.style.display = 'none';
                }
            };

            // Refresh map data
            window.refreshMapData = function() {
                if (map && currentData.length > 0) {
                    updateMapMarkers(currentData);
                }
            };

            // Center map
            window.centerMap = function() {
                if (map) {
                    map.setView([FIMA_COORDINATES.lat, FIMA_COORDINATES.lng], 17);
                }
            };

            // Toggle all markers
            window.toggleAllMarkers = function() {
                const btn = document.getElementById('toggle-markers');
                if (!btn || markers.length === 0) return;
                
                const isVisible = markers[0]?.isPopupOpen() || false;
                
                markers.forEach(marker => {
                    if (isVisible) {
                        marker.closePopup();
                    } else {
                        marker.openPopup();
                    }
                });
                
                btn.innerHTML = isVisible ? 
                    '<i class="bx bx-show"></i> Show All' : 
                    '<i class="bx bx-hide"></i> Hide All';
            };

            // Export tank chart
            window.exportTankChart = function() {
                if (!tankDetailChart) {
                    alert('No chart to export');
                    return;
                }
                
                const link = document.createElement('a');
                link.download = `tank-${currentTankId}-chart-${new Date().toISOString().slice(0, 10)}.png`;
                link.href = tankDetailChart.toBase64Image();
                link.click();
            };

            // Close modal
            window.closeModal = function() {
                const tankModal = document.getElementById('tank-modal');
                if (tankModal) {
                    tankModal.style.display = 'none';
                }
                if (tankDetailChart) {
                    tankDetailChart.destroy();
                    tankDetailChart = null;
                }
                currentTankId = null;
                allTankHistory = [];
                currentStartDate = null;
                currentEndDate = null;
                chartRawData = [];
                
                // Clear canvas
                const canvas = document.getElementById('tank-detail-chart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                }
                
                // Reset chart info
                const chartDataRange = document.getElementById('chart-data-range');
                const pointCount = document.getElementById('chart-point-count');
                if (chartDataRange) chartDataRange.textContent = 'Showing data for: Last 7 days';
                if (pointCount) pointCount.textContent = '0 data points';
            };

            // Update loading state
            function updateLoadingState(isLoading) {
                const statsCards = document.querySelectorAll('.stat-value');
                
                if (isLoading) {
                    statsCards.forEach(card => {
                        if (card.textContent === '--') {
                            card.innerHTML = '<span class="skeleton" style="width: 60px; height: 32px; display: inline-block;"></span>';
                        }
                    });
                }
            }

            // Helper function to show error
            function showError(message) {
                console.error('Dashboard error:', message);
                
                // Update connection status
                updateConnectionStatus('Error: ' + message, 'error');
                
                // Show error in stats
                const stats = ['avg-temp', 'max-temp', 'min-temp', 'normal-tanks', 'warning-tanks'];
                stats.forEach(stat => {
                    const element = document.getElementById(stat);
                    if (element) {
                        element.textContent = '--';
                    }
                });
            }

            // Initialize when DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                // Check if we're on the dashboard page
                if (document.querySelector('[href="index.html"]') || window.location.pathname.includes('index') || window.location.pathname.endsWith('/')) {
                    setTimeout(() => {
                        initDashboard();
                    }, 100);
                }
            });

        })();
    </script>
</body>
</html>
